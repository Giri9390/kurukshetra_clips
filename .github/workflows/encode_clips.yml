name: Encode Kurukshetra Clips

on:
  workflow_dispatch:

jobs:
  encode:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo with LFS enabled
      uses: actions/checkout@v3
      with:
        lfs: true

    - name: Pull actual LFS video files
      run: git lfs pull

    - name: Install ffmpeg
      run: sudo apt-get update && sudo apt-get install -y ffmpeg

    - name: Encode all clips in /github folder
      run: |
        mkdir -p encoded/
        for FILE in github/*.mp4; do
          BASENAME=$(basename "$FILE")
          OUT="encoded/$BASENAME"
          ffmpeg -i "$FILE" \
            -vcodec libx264 \
            -preset fast \
            -acodec aac \
            -movflags +faststart \
            -pix_fmt yuv420p \
            "$OUT" -y
        done

    - name: Commit encoded clips
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add encoded/*.mp4 || true
        if git diff --cached --quiet; then
          echo "No new encoded clips"
        else
          git commit -m "Encoded Kurukshetra clips"
          git push
        fi
